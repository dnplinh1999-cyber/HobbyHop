<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HobbyHop - Stop Committing, Start Exploring</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic components -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles for the fun, developmental tone */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Customizing colors for Tailwind to match the logo */
        :root {
            --color-hop-red: #EA4335;
            --color-hop-blue: #4285F4;
            --color-hop-green: #34A853;
        }

        .text-hop-red { color: var(--color-hop-red); }
        .bg-hop-red { background-color: var(--color-hop-red); }
        .text-hop-blue { color: var(--color-hop-blue); }
        .bg-hop-blue { background-color: var(--color-hop-blue); }
        .text-hop-green { color: var(--color-hop-green); }
        .bg-hop-green { background-color: var(--color-hop-green); }

        /* Custom shadow for cards/buttons */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Responsive Adventure Board Grid */
        .adventure-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        /* Scrollable Bundle Section: SCROLLBAR IS NOW VISIBLE */
        .scroll-container {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 1rem;
            -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
            /* Removed scrollbar-width: none; for visibility */
        }
        /* Removed ::-webkit-scrollbar display: none; for visibility */
        
        /* New centered icon style for the hurdles section */
        .centered-icon-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* Duolingo style path for milestones */
        .milestone-path {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }
        .milestone {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 10;
        }
        .milestone-node {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 4px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .milestone:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 25px;
            left: 25px; /* Offset by half the node size */
            height: 4px;
            width: 100%;
            background-color: #E5E7EB; /* Gray line */
            z-index: 5;
            transform: translateX(25px); /* Start line after the node */
        }

        /* Floating Chat Button */
        #chat-float-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        /* Chat Modal Styles */
        .chat-modal-content {
            width: 100%;
            max-width: 400px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Navigation Header (Always Visible) -->
        <header id="main-header" class="bg-white card-shadow sticky top-0 z-50">
            <!-- Content will be rendered by renderHeader() -->
        </header>

        <!-- Main Content Area (Dynamically Rendered) -->
        <main id="main-content" class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 overflow-x-hidden"></main>
        
        <!-- Floating Chat Button (New Feature) -->
        <div id="chat-float-button">
            <button onclick="toggleChatModal()" class="bg-hop-red text-white p-4 rounded-full shadow-lg hover:bg-red-600 transition card-shadow">
                <i data-lucide="message-square" class="w-6 h-6"></i>
            </button>
        </div>
        
        <!-- Chat Modal Container -->
        <div id="chat-modal-container" class="hidden fixed inset-0 z-50 flex justify-end items-end p-4 pointer-events-none">
            <div class="chat-modal-content pointer-events-auto">
                <!-- Content will be rendered by renderChatModal() -->
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-auto">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                    <div>
                        <h4 class="font-bold mb-3 text-hop-green">HobbyHop</h4>
                        <ul class="space-y-2 text-sm">
                            <li><a href="#" onclick="event.preventDefault(); goToView('about')" class="hover:text-hop-blue">Our Mission</a></li>
                            <li><a href="#" onclick="event.preventDefault(); goToView('register')" class="hover:text-hop-blue">Sign Up</a></li>
                            <li><a href="#" onclick="event.preventDefault(); goToView('partners')" class="hover:text-hop-blue">Become a Partner</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-3 text-hop-green">Discovery</h4>
                        <ul class="space-y-2 text-sm">
                            <li><a href="#" onclick="event.preventDefault(); goToView('adventure')" class="hover:text-hop-blue">Adventure Board</a></li>
                            <li><a href="#" onclick="event.preventDefault(); goToView('bundles')" class="hover:text-hop-red transition">Bundles</a></li>
                            <li><a href="#" onclick="event.preventDefault(); goToView('referral')" class="hover:text-hop-blue">Refer & Earn</a></li>
                            <!-- REMOVED: Image Lab (Demo) -->
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold mb-3 text-hop-green">Legal & Support</h4>
                        <ul class="space-y-2 text-sm">
                            <li><a href="#" onclick="event.preventDefault(); goToView('faq')" class="hover:text-hop-blue">FAQs</a></li>
                            <li><a href="#" onclick="event.preventDefault(); goToView('trust')" class="hover:text-hop-blue">Trust & Security</a></li>
                            <li><a href="#" onclick="event.preventDefault(); goToView('contact')" class="hover:text-hop-blue">Contact Us</a></li>
                        </ul>
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <h4 class="font-bold mb-3 text-hop-green">Stay Connected</h4>
                        <p class="text-sm">Follow us for new Hop-In options in Toronto!</p>
                        <!-- Mock Social Icons -->
                        <div class="flex space-x-4 mt-3">
                            <i data-lucide="instagram" class="w-6 h-6 hover:text-hop-red transition"></i>
                            <i data-lucide="facebook" class="w-6 h-6 hover:text-hop-blue transition"></i>
                            <i data-lucide="mail" class="w-6 h-6 hover:text-hop-red transition"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center py-4 bg-gray-900 text-xs">
                &copy; 2025 HobbyHop. All Rights Reserved.
            </div>
        </footer>
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        // --- Gemini API Utility Functions ---
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // Placeholder, Canvas will inject key at runtime

        async function callGeminiApi(userQuery, systemPrompt, chatHistory = [], maxRetries = 3) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            
            const contents = [
                // Only use the user's latest query and current chat history
                ...chatHistory,
                { role: "user", parts: [{ text: userQuery }] }
            ];

            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        return text;
                    }
                    return "I'm sorry, I couldn't generate a response right now.";

                } catch (error) {
                    console.error(`Gemini API Call failed (Attempt ${i + 1}):`, error);
                    if (i === maxRetries - 1) throw new Error("Gemini API failed after multiple retries.");
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // --- State Management ---
        window.state = {
            view: 'home', // 'home', 'adventure', 'pricing', 'partners', 'register', 'activityDetail', 'bundles', 'about', 'referral', 'profile', 'login', 'contact', 'trust'
            user: {
                isLoggedIn: false,
                location: 'Toronto, ON',
                childProfile: 'Ages 8-12, Sports Focus',
                passes: 4, // NEW: Class Passes (replaces credits)
                hopPoints: 500, // EARNED Reward Points (RENAMED)
                referralCode: 'HOP2025'
            },
            filters: {
                type: '',
                time: '',
                location: 'Liberty Village', // Default to a Toronto neighborhood
                minRating: 0
            },
            isMobileMenuOpen: false, // NEW: Mobile menu state
            
            // --- CHAT STATE ---
            chatHistory: [{
                role: "model",
                parts: [{ text: "Hi there! I'm the HobbyHop Support Assistant. I can answer questions about <strong>Class Passes</strong>, <strong>Hop Points</strong>, <strong>Referrals</strong>, and our mission to simplify activities for Toronto families. How can I help you start exploring?" }]
            }],
            isChatOpen: false,
            // --- END CHAT STATE ---

            // Mock Activity Detail data fetch
            getActivityById: function(id) {
                return this.mockActivities.find(a => a.id === id);
            },
            
            // --- NEW FLAT-RATE ECONOMY CONSTANTS ---
            PASSES_PER_CLASS: 1, // NEW: All Hop-In classes cost 1 Pass
            HP_FOR_FREE_PASS: 100, // NEW: 100 HP = 1 Free Pass
            REFERRAL_HP_BONUS: 100, // CORRECTED: 100 HP = 1 Free Pass (FINANCIALLY SUSTAINABLE)
            
            // Mock Gemini review summary (AI integration)
            getGeminiSummary: function(reviews) {
                // This remains mocked for stable UI, focusing real API calls on the new interactive features.
                return `<strong>Gemini Summary:</strong> Parents consistently praise the <strong>Instructor Credibility</strong> (95% positive mentions) and highlight the <strong>Fun/Enjoyment</strong> factor. Minor feedback noted Location Convenience but overall, this is a top-rated activity for <strong>Skill Building</strong>.`;
            },
            
            // Mock Activities Data (ALL COST 1 PASS)
            mockActivities: [
                { id: 1, name: 'Intro to Acrobatics', provider: 'Flip & Tumble Studio', passes: 1, time: 'Mon, 6:30 PM', location: 'North York', rating: 4.9, tags: ['Skill Building', 'Safety', 'Fun/Enjoyment'], instructor: { name: 'Hannah Lee', cert: 'NCCP Level 2, 10+ Years Exp.', testimonial: 'Hannah is the best acrobatic teacher any child could ever ask for!' } },
                { id: 2, name: 'Youth Soccer Skills Drop-In', provider: 'North Star Sports Club', passes: 1, time: 'Sat, 9:00 AM', location: 'The Annex', rating: 4.2, tags: ['Location Convenience', 'Fun/Enjoyment'], instructor: { name: 'Coach Mike D.', cert: 'FIFA Youth, 5 Years Exp.', testimonial: 'Coach Mike makes learning teamwork truly fun and engaging for everyone.' } },
                { id: 3, name: 'Beginner Robotics Workshop', provider: 'STEM Explorers Lab', passes: 1, time: 'Sun, 1:00 PM', location: 'Downtown Core', rating: 4.7, tags: ['Skill Building', 'Instructor Credibility', 'STEM'], instructor: { name: 'Dr. Jane Smith', cert: 'Ph.D. Engineering, 15+ Years Exp.', testimonial: 'Dr. Smith breaks down complex concepts into simple, fun steps.' } },
                { id: 4, name: 'Creative Arts & Drawing', provider: 'The Paint Spot', passes: 1, time: 'Wed, 4:00 PM', location: 'Liberty Village', rating: 4.5, tags: ['Fun/Enjoyment', 'Skill Building', 'Art'], instructor: { name: 'Sarah Chen', cert: 'B.A. Fine Arts, 7 Years Exp.', testimonial: 'Sarah is patient and encourages every child to be creative.' } },
                { id: 5, name: 'Martial Arts (Basic Kicks)', provider: 'Dragon Dojo', passes: 1, time: 'Tue, 5:30 PM', location: 'Etobicoke', rating: 5.0, tags: ['Safety', 'Discipline', 'Sport'], instructor: { name: 'Sensei Kenji', cert: '5th Dan Black Belt, 20 Years Exp.', testimonial: 'Sensei Kenji provides a firm but incredibly supportive environment for learning respect.' } },
                { id: 16, name: 'Grade 6 Math Prep', provider: 'Apex Tutoring Center', passes: 1, time: 'Wed, 7:00 PM', location: 'North York', rating: 4.8, tags: ['Academic', 'Skill Building', 'Focus'], instructor: { name: 'Mr. David K.', cert: 'B.Ed. OISE, 12 Years Exp.', testimonial: 'David makes complex math problems feel easy and boost student confidence.' } },
                { id: 17, name: 'Reading Comprehension Workshop', provider: 'Word Wizards Academy', passes: 1, time: 'Mon, 4:00 PM', location: 'The Annex', rating: 4.7, tags: ['Academic', 'Focus', 'Literacy'], instructor: { name: 'Ms. Emily R.', cert: 'M.A. English, 8 Years Exp.', testimonial: 'Emily uses fun stories to drastically improve reading speed and understanding.' } },
                { id: 18, name: 'Coding Fundamentals for Youth', provider: 'STEM Explorers Lab', passes: 1, time: 'Sun, 10:00 AM', location: 'Downtown Core', rating: 4.9, tags: ['Academic', 'STEM', 'Skill Building'], instructor: { name: 'Dr. John B.', cert: 'Ph.D. CS, 10+ Years Exp.', testimonial: 'John teaches practical coding skills that translate directly into school projects.' } },
                { id: 6, name: 'Youth Basketball Drill', provider: 'City Hoops League', passes: 1, time: 'Thu, 7:00 PM', location: 'Downtown Core', rating: 4.6, tags: ['Skill Building', 'Teamwork', 'Sport'], instructor: { name: 'Coach Jay', cert: 'NCCP Level 1, 8 Years Exp.', testimonial: 'Coach Jay focuses on fundamentals, building confidence with every shot.' } },
                { id: 7, name: 'Creative Pottery Class', provider: 'Clay Dreams Studio', passes: 1, time: 'Sun, 11:00 AM', location: 'North York', rating: 4.8, tags: ['Fun/Enjoyment', 'Art', 'Sensory'], instructor: { name: 'Maria F.', cert: 'MFA, 12 Years Exp.', testimonial: 'Maria creates a calming and inspiring space for kids to explore clay.' } },
                { id: 8, name: 'Chess Strategy Basics', provider: 'Master Minds Club', passes: 1, time: 'Tue, 5:00 PM', location: 'Etobicoke', rating: 4.9, tags: ['Skill Building', 'STEM', 'Focus'], instructor: { name: 'Mr. Liu', cert: 'FIDE Master, 15 Years Exp.', testimonial: 'Mr. Liu makes complex strategies accessible and engaging for all ages.' } },
                { id: 9, name: 'Bollywood Kids Dance', provider: 'Rhythm Fusion Arts', passes: 1, time: 'Fri, 4:30 PM', location: 'The Annex', rating: 4.7, tags: ['Fun/Enjoyment', 'Music', 'Movement'], instructor: { name: 'Priya K.', cert: 'Certified Dance Instructor, 6 Years Exp.', testimonial: 'Priya\'s energy is infectious! My child loves the music and movement.' } },
                { id: 10, name: 'Intro to Fencing Trial', provider: 'Steel Blade Academy', passes: 1, time: 'Wed, 6:00 PM', location: 'Downtown Core', rating: 4.5, tags: ['Safety', 'Skill Building', 'Sport'], instructor: { name: 'Coach Ivan', cert: 'Olympic Prep Certified, 18 Years Exp.', testimonial: 'A safe, disciplined environment to learn a unique sport.' } },
                { id: 11, name: 'Intro to Piano Keys', provider: 'Music Maker Studio', passes: 1, time: 'Sat, 10:00 AM', location: 'North York', rating: 4.4, tags: ['Music', 'Skill Building', 'Focus'], instructor: { name: 'Ms. Clara', cert: 'RCM Certified, 10 Years Exp.', testimonial: 'Clara makes music theory engaging and fun!' } },
                { id: 12, name: 'Creative Writing Basics', provider: 'Word Wizards Academy', passes: 1, time: 'Thu, 4:30 PM', location: 'Etobicoke', rating: 4.7, tags: ['STEM', 'Skill Building', 'Focus'], instructor: { name: 'Mr. Finn', cert: 'B.A. English, 5 Years Exp.', testimonial: 'Mr. Finn teaches storytelling that captivating even the shyest child.' } },
                { id: 13, name: 'Indoor Rock Climbing Trial', provider: 'Vertical Fun Gym', passes: 1, time: 'Fri, 6:00 PM', location: 'The Annex', rating: 4.8, tags: ['Sport', 'Safety', 'Fun/Enjoyment'], instructor: { name: 'Coach Alex', cert: 'CWA Safety, 4 Years Exp.', testimonial: 'Alex ensures every climb is safe, challenging, and rewarding.' } },
                { id: 14, name: 'Junior Science Lab', provider: 'Curiosity Crew', passes: 1, time: 'Sat, 1:30 PM', location: 'Downtown Core', rating: 4.6, tags: ['STEM', 'Instructor Credibility', 'Discovery'], instructor: { name: 'Dr. Ziad', cert: 'M.Sc. Chemistry, 9 Years Exp.', testimonial: 'Dr. Ziad makes chemistry experiments explode with fun (safely!).' } },
                { id: 15, name: 'Hip-Hop Dance Fusion', provider: 'The Movement Studio', passes: 1, time: 'Wed, 5:00 PM', location: 'Liberty Village', rating: 4.5, tags: ['Music', 'Fun/Enjoyment', 'Movement'], instructor: { name: 'Jasmine C.', cert: 'Certified Choreographer, 8 Years Exp.', testimonial: 'Jasmine brings incredible energy and great routines.' } }
            ],

            // Mock Bundles Data (Cost based on number of activities * 1 Pass)
            mockBundles: [
                { id: 101, name: 'Future Olympian Pack', image: 'https://media.istockphoto.com/id/583849618/photo/group-of-teenage-runners-lined-up-ready-to-race.jpg?s=612x612&w=0&k=20&c=1ELx-U_C38QRIk-s9urUvnjOCgRDnpJQIxk8mCUdpmk=', theme: 'High-Energy Sports', focus: 'Teamwork & Stamina', activities: 4, passes: 4, description: "Kickstart competitive competitive spirit with soccer, martial arts, and track." },
                { id: 102, name: 'Creative Genius Journey', image: 'https://blog.nemours.org/wp-content/uploads/2020/04/GettyImages-1172681503-scaled.jpg', theme: 'Arts, Music & STEM', focus: 'Cognitive & Fine Motor', activities: 5, passes: 5, description: "Explore robotics, painting, piano, and sensory play activities." },
                { id: 103, name: 'Urban Explorer Starter Kit', image: 'https://www.shutterstock.com/image-photo/checking-way-on-map-kids-260nw-2492719195.jpg', theme: 'Nature & Movement', focus: 'Balance & Discovery', activities: 3, passes: 3, description: "Outdoor focused: climbing, parkour, and nature exploration." },
                { id: 104, name: 'The Quiet Contemplator', image: 'https://www.kidzone.ws/science/lessons/images/children-doing-science.jpg', theme: 'Focus & Logic', focus: 'Strategy & Patience', activities: 4, passes: 4, description: "Activities focusing on chess, coding basics, and specialized reading." },
            ],
            
            // Mock Partner Stats (for Page F)
            mockPartnerStats: {
                newFamilies: 1200, // Reach/Exposure
                adminTimeSaved: 85, // Operational Efficiency (%)
                totalBookings: 25000 // Reach/Exposure
            },

            // Team Members from VFPTeam3-ScopeofWork.pdf
            teamMembers: [
                { name: "Catherine Cheung", role: "Strategy & Finance" },
                { name: "Linh Dinh", role: "Market Research" },
                { name: "Jennifer Do", role: "Customer Insights" },
                { name: "Gwyneth Gonzales", role: "Marketing & Outreach" },
                { name: "Christoph Bjarne Wemme", role: "Technology & Operations" },
                { name: "Justin Zheng", role: "Partnership Development" }
            ],
            
            // NEW: Duolingo-inspired Milestones
            mockMilestones: [
                // Reward: HP | Conversion: 100 HP = 1 Pass
                { name: 'First Hop-In', progress: 1, required: 1, reward: 50, icon: 'ticket', complete: true }, // 0.5 Pass
                { name: 'Master the Filter', progress: 1, required: 5, reward: 75, icon: 'search', complete: true }, // 0.75 Pass
                { name: 'Social Butterfly', progress: 0, required: 1, reward: 100, icon: 'message-square', complete: false }, // 1 Free Pass
                { name: 'Explore 3 Arts', progress: 0, required: 3, reward: 150, icon: 'palette', complete: false }, // 1.5 Passes
                { name: 'The Diplomat', progress: 0, required: 1, reward: 200, icon: 'gift', complete: false }, // 2 Free Passes
            ]
        };
        
        // --- Chatbot Logic ---
        function toggleChatModal() {
            window.state.isChatOpen = !window.state.isChatOpen;
            renderChatModal();
        }

        const HOBBYHOP_SYSTEM_PROMPT = `You are the expert HobbyHop Support Assistant. Your goal is to answer parents' questions about the platform in a friendly, trustworthy, and concise manner.
Key Facts to Ground Your Answers:
1. Core Mission: Solve parental pain points: fragmented discovery, high sunk costs, and rigid scheduling in Toronto.
2. Paid Currency: **Class Passes** are bought via subscription tiers and are used to book Hop-In Classes. All classes cost 1 Pass.
3. Reward Currency: **Hop Points (HP)** are earned via milestones and reviews. They can be redeemed at a fixed rate of **100 HP = 1 Free Class Pass**.
4. Referral Bonus: A successful referral grants **${window.state.REFERRAL_HP_BONUS} HP** to both the referrer and the friend (equal to ${window.state.REFERRAL_HP_BONUS / window.state.HP_FOR_FREE_PASS} Free Class Passes).
5. Geographic Focus: Toronto neighborhoods (Downtown Core, North York, etc.).`;

        async function handleChatSubmit(event) {
            event.preventDefault();
            const chatInput = document.getElementById('chat-input');
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // Add user message to history immediately
            window.state.chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            chatInput.value = ''; // Clear input
            renderChatModal(); // Re-render to show user message

            const chatMessagesContainer = document.getElementById('chat-messages');
            chatMessagesContainer.innerHTML += `<div class="p-2 text-sm text-gray-500 flex items-center space-x-1 justify-end" id="loading-indicator">
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-hop-red"></i><span>Typing...</span>
            </div>`;
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            lucide.createIcons();

            try {
                const responseText = await callGeminiApi(userQuery, HOBBYHOP_SYSTEM_PROMPT, window.state.chatHistory);
                
                // Add AI response to history
                window.state.chatHistory.push({ role: "model", parts: [{ text: responseText }] });
                
                // Remove loading indicator before re-rendering
                document.getElementById('loading-indicator')?.remove();
                
                renderChatModal();
            } catch (error) {
                // Handle API failure in the chat UI
                window.state.chatHistory.push({ role: "model", parts: [{ text: "I'm sorry, I'm experiencing connectivity issues right now. Please try again in a moment." }] });
                document.getElementById('loading-indicator')?.remove();
                renderChatModal();
            }
        }
        
        function renderChatModal() {
            const container = document.getElementById('chat-modal-container');
            if (!container) return;

            if (window.state.isChatOpen) {
                container.classList.remove('hidden');
                
                const chatContent = `
                    <div class="chat-modal-content flex flex-col">
                        <!-- Chat Header -->
                        <div class="bg-hop-blue text-white p-3 rounded-t-xl flex justify-between items-center">
                            <span class="font-bold flex items-center space-x-2">
                                <i data-lucide="sparkles" class="w-5 h-5 fill-white"></i>
                                <span>HobbyHop Assistant</span>
                            </span>
                            <button onclick="toggleChatModal()" class="text-white hover:text-gray-300">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <!-- Messages Body -->
                        <div id="chat-messages" class="flex-grow p-3 overflow-y-auto space-y-3 bg-gray-50">
                            ${window.state.chatHistory.map(msg => `
                                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                                    <div class="max-w-[80%] p-2 rounded-lg text-sm shadow ${msg.role === 'user' ? 'bg-hop-green text-white' : 'bg-gray-200 text-gray-800'}">
                                        ${msg.parts[0].text}
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Chat Input -->
                        <form onsubmit="handleChatSubmit(event)" class="p-3 border-t border-gray-200">
                            <div class="flex space-x-2">
                                <input id="chat-input" type="text" placeholder="Ask about Passes or Referrals..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-hop-blue focus:border-hop-blue" required>
                                <button type="submit" class="bg-hop-red text-white p-2 rounded-lg hover:bg-red-600">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                container.querySelector('.chat-modal-content').innerHTML = chatContent;
                
                // Scroll to bottom
                const chatMessagesContainer = document.getElementById('chat-messages');
                if (chatMessagesContainer) {
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
                
                lucide.createIcons();
            } else {
                container.classList.add('hidden');
            }
        }

        /**
         * Function to explicitly toggle the rotation of the chevron icon in the FAQ.
         * @param {string} iconId - The ID of the Lucide icon element.
         * @param {HTMLElement} detailsElement - The parent <details> element.
         */
        function toggleIcon(iconId, detailsElement) {
            const icon = document.getElementById(iconId);
            if (icon) {
                icon.style.transition = 'transform 0.3s';
                // Check if the details element is NOT currently open (meaning it's about to open)
                if (!detailsElement.open) { 
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    icon.style.transform = 'rotate(0deg)';
                }
            }
        }

        /**
         * Toggles the visibility of the mobile menu.
         */
        function toggleMobileMenu() {
            window.state.isMobileMenuOpen = !window.state.isMobileMenuOpen;
            renderApp();
        }

        /**
         * Renders the authentication buttons based on the user's login state.
         */
        function renderAuthButtons() {
            const authContainer = document.getElementById('auth-buttons');
            let authContent = '';

            if (window.state.user.isLoggedIn) {
                // Logged In Dashboard View - Shows both Credits (Paid) and Hop Points (Earned)
                authContent = `
                    <div class="hidden sm:flex items-center space-x-2 text-sm font-semibold bg-gray-100 p-2 rounded-full cursor-pointer" onclick="goToView('profile')">
                        <i data-lucide="ticket" class="w-4 h-4 text-hop-blue fill-hop-blue"></i>
                        <span class="text-hop-blue">${window.state.user.passes} Passes</span>
                    </div>
                    <div class="hidden sm:flex items-center space-x-2 text-sm font-semibold bg-gray-100 p-2 rounded-full cursor-pointer" onclick="goToView('profile')">
                        <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-yellow-500"></i>
                        <span class="text-yellow-700">${window.state.user.hopPoints} HP</span>
                    </div>
                    <button onclick="goToView('profile')" class="bg-hop-blue text-white py-2 px-4 rounded-full font-bold hover:bg-blue-600 transition card-shadow hidden sm:block">
                        My Account
                    </button>
                    <button onclick="handleSignOut()" class="text-gray-500 font-semibold hover:text-hop-red transition">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                `;
            } else {
                // Logged Out CTA View
                authContent = `
                    <button onclick="goToView('register')" class="bg-hop-red text-white py-2 px-4 rounded-full font-bold hover:bg-red-600 transition card-shadow">
                        Start Adventure
                    </button>
                    <!-- Log In button routes to the dedicated login page -->
                    <button onclick="goToView('login')" class="text-hop-blue font-semibold hover:text-blue-700 hidden sm:block">Log In</button>
                `;
            }

            authContainer.innerHTML = authContent;
            lucide.createIcons(); // Re-initialize icons
        }

        /**
         * Renders the header, including the dynamic mobile menu.
         */
        function renderHeader() {
            const headerContainer = document.getElementById('main-header');
            
            const mobileNavLinks = `
                <div class="md:hidden bg-gray-50 border-t border-gray-200 py-3 px-4">
                    <div class="flex flex-col space-y-3 font-semibold text-gray-800">
                        <a href="#" onclick="event.preventDefault(); goToView('adventure')" class="hover:text-hop-blue transition border-b pb-2">Adventure Board</a>
                        <a href="#" onclick="event.preventDefault(); goToView('bundles')" class="hover:text-hop-red transition border-b pb-2">Bundles</a>
                        <a href="#" onclick="event.preventDefault(); goToView('pricing')" class="hover:text-hop-blue transition border-b pb-2">Pricing</a>
                        <a href="#" onclick="event.preventDefault(); goToView('partners')" class="hover:text-hop-blue transition">Partnership</a>
                        
                        <div class="pt-4 border-t border-gray-200">
                            ${window.state.user.isLoggedIn ? 
                                `<a href="#" onclick="event.preventDefault(); goToView('profile')" class="text-hop-blue hover:text-blue-700">My Account</a>` : 
                                `<a href="#" onclick="event.preventDefault(); goToView('login')" class="text-hop-blue hover:text-blue-700">Log In / Sign Up</a>`
                            }
                        </div>
                    </div>
                </div>
            `;

            headerContainer.innerHTML = `
                <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                    <!-- Logo/Brand -->
                    <a href="#" onclick="goToView('home')" class="text-3xl font-extrabold flex items-center">
                        <span class="text-hop-red">H</span><span class="text-hop-blue">obby</span><span class="text-hop-red">H</span><span class="text-hop-green">op</span>
                    </a>

                    <!-- Desktop Nav Links -->
                    <div class="hidden md:flex space-x-6 text-gray-700 font-semibold">
                        <a href="#" onclick="goToView('adventure')" class="hover:text-hop-blue transition">Adventure Board</a>
                        <a href="#" onclick="goToView('bundles')" class="hover:text-hop-red transition">Bundles</a>
                        <a href="#" onclick="goToView('pricing')" class="hover:text-hop-blue transition">Pricing</a>
                        <a href="#" onclick="goToView('partners')" class="hover:text-hop-blue transition">Partnership</a>
                    </div>

                    <!-- Auth/CTA Buttons & Mobile Menu Toggle -->
                    <div class="flex items-center space-x-3">
                        <div id="auth-buttons" class="hidden sm:flex items-center space-x-3">
                            <!-- Dynamic Auth Content will be rendered here -->
                        </div>
                        <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-md text-gray-700 hover:bg-gray-100">
                            <i data-lucide="${window.state.isMobileMenuOpen ? 'x' : 'menu'}" class="w-6 h-6"></i>
                        </button>
                    </div>
                </nav>
                
                <!-- Mobile Menu Content (Collapsible) -->
                ${window.state.isMobileMenuOpen ? mobileNavLinks : ''}
            `;
            // Must call renderAuthButtons to populate the dynamic section inside the header HTML
            renderAuthButtons();
            lucide.createIcons(); // Re-initialize icons
        }

        /**
         * Core navigation function. Updates state and calls the main renderer.
         */
        function goToView(newView, data = {}) {
            if (newView === window.state.view && data.id === window.state.dataId) return;

            window.state.view = newView;
            window.state.data = data;
            window.state.dataId = data.id || null;
            window.state.isMobileMenuOpen = false; // Close menu on navigation
            renderApp(); // This is the corrected call
            window.scrollTo(0, 0); 
        }

        /**
         * Main rendering function. Determines which view to show.
         */
        function renderApp() {
            const container = document.getElementById('main-content');
            let htmlContent = '';

            // Render navigation header first (dynamic based on mobile state)
            renderHeader();

            // Render chat modal state
            renderChatModal(); 

            switch (window.state.view) {
                case 'home':
                    htmlContent = renderHomeView();
                    break;
                case 'login':
                    htmlContent = renderLoginPage();
                    break;
                case 'register':
                    htmlContent = renderRegisterPage();
                    break;
                case 'adventure':
                    htmlContent = renderAdventureBoard();
                    break;
                case 'pricing':
                    htmlContent = renderPricingPage();
                    break;
                case 'partners':
                    htmlContent = renderPartnersPage();
                    break;
                case 'bundles':
                    htmlContent = renderBundlesPage();
                    break;
                case 'about':
                    htmlContent = renderAboutPage();
                    break;
                case 'referral':
                    htmlContent = renderReferralPage(); 
                    break;
                case 'contact':
                    htmlContent = renderContactPage(); // NEW: Contact Us Page
                    break;
                case 'trust':
                    htmlContent = renderTrustSecurityPage(); // NEW: Trust & Security Page
                    break;
                case 'faq':
                    htmlContent = renderFAQPage(); // NEW: Dedicated FAQ Page
                    break;
                case 'profile':
                    htmlContent = renderPlaceholderView(window.state.view);
                    break;
                case 'activityDetail':
                    htmlContent = renderActivityDetail(window.state.dataId);
                    break;
                default:
                    htmlContent = `<h1 class="text-4xl text-hop-red">404 - Page Not Found</h1>`;
            }
            container.innerHTML = htmlContent;
            lucide.createIcons(); // Initialize Lucide icons after DOM update
        }

        // --- Event Handlers (Called from inline HTML) ---

        function handleSignUp(event) {
            event.preventDefault();
            
            const form = event.target;
            const email = form.elements['email'].value;
            const location = form.elements['location'].value;
            const age = form.elements['child-age'].value;
            const interest = form.elements['child-interest'].value;

            // Update mock user state
            window.state.user.isLoggedIn = true;
            window.state.user.email = email;
            window.state.user.location = location;
            window.state.user.childProfile = `Age ${age}, Interest: ${interest}`;
            // Give initial Hop Points, not Passes, for signing up (Gamification)
            window.state.user.hopPoints += 100; 
            
            console.log('Mock Sign Up successful. User Data:', window.state.user);
            // Navigate to the Bundles Page ("bundle shop")
            goToView('bundles', { message: `Welcome ${email}! Your profile is set. Choose your starting bundle!` });
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = event.target.elements['login-email'].value;
            
            // Simulate successful login
            window.state.user.isLoggedIn = true;
            window.state.user.email = email;
            
            console.log('Mock Log In successful. User Data:', window.state.user);
            // Default post-login destination is the Adventure Board
            goToView('adventure', { message: `Successfully logged in. Welcome back!` });
        }

        function handleSignOut() {
            window.state.user.isLoggedIn = false;
            window.state.user.email = null;
            goToView('home');
        }

        function applyFilters() {
            // In a real app, this would fetch data from Firestore based on window.state.filters
            // Simply navigates to the adventure view to show the filtered state, which will now use the new default prompt
            goToView('adventure', { message: `Filters applied to ${window.state.filters.location || 'Toronto'}. Refine your search!` });
        }
        
        // --- View Templates ---
        
        function renderTrustSecurityPage() {
            return `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl card-shadow">
                    <h1 class="text-4xl font-extrabold text-hop-green mb-6 flex items-center space-x-3">
                        <i data-lucide="shield" class="w-8 h-8"></i>
                        <span>Trust & Security Policy</span>
                    </h1>
                    <p class="text-lg text-gray-600 mb-8">
                        Your family's safety, privacy, and peace of mind are our highest priority. This document outlines how we protect your data and ensure a secure environment for every Hop-In adventure.
                    </p>

                    <h2 class="text-2xl font-bold text-hop-blue mb-4">1. How We Handle Your Data (Privacy Policy)</h2>
                    <p class="mb-4">
                        We collect minimal data necessary to fulfill our core service: matching your child to local activities and managing bookings. We adhere strictly to Canadian privacy laws.
                    </p>
                    <ul class="list-disc list-inside space-y-2 ml-4 mb-6 text-gray-700">
                        <li><strong>Data Collected:</strong> Parent Email, Password (encrypted), Child's Age Range, Child's Interests, and Location (Toronto neighborhood).</li>
                        <li><strong>Usage of Data:</strong> Your data is used exclusively for personalized activity recommendations, optimizing the Adventure Board, and processing transactions. We <strong>never</strong> sell or rent your personal information to third parties.</li>
                        <li><strong>Provider Anonymity:</strong> Activity providers (our partners) only receive necessary information, such as the booking time and the child's age rangeâ€”never your contact information or personal profile details.</li>
                        <li><strong>Security Measures:</strong> All parent accounts and financial data are secured using industry-standard encryption protocols (SSL/TLS).</li>
                    </ul>
                    
                    <h2 class="text-2xl font-bold text-hop-red mb-4 border-t pt-6">2. Safety and Instructor Credibility</h2>
                    <p class="mb-4">
                        We understand that trust begins with the people teaching your children. We employ strict vetting processes for all partners joining the HobbyHop network.
                    </p>
                    <ul class="list-disc list-inside space-y-2 ml-4 mb-10 text-gray-700">
                        <li><strong>Vetting Process:</strong> Every partner organization must provide evidence of instructor certifications (e.g., NCCP, RCM, B.Ed.), valid insurance, and adherence to local safety standards for children's programs.</li>
                        <li><strong>Community Feedback Loop:</strong> Our 5-star rating system and AI Review Insights rely on verified parent bookings to flag any issues instantly, creating an accountability loop for instructors.</li>
                        <li><strong>Emergency Protocols:</strong> We require all providers to confirm they have clear, practiced emergency and incident reporting protocols in place.</li>
                        <li><strong>AI Transparency:</strong> Features like the **AI Instructor Q&A** only pull information from the pre-vetted data provided on the instructor's public profile, ensuring the information is verifiable and grounded.</li>
                    </ul>
                    
                    <div class="mt-8 pt-4 border-t text-center">
                        <button onclick="goToView('contact')" class="bg-hop-blue text-white py-3 px-6 rounded-full font-bold hover:bg-blue-600 transition">
                            Still Have Questions? Contact Our Support Team
                        </button>
                    </div>
                </div>
            `;
        }

        function renderFAQPage() {
            const HP_PER_FREE_PASS = window.state.HP_FOR_FREE_PASS;
            const PASSES_PER_CLASS = window.state.PASSES_PER_CLASS;

            const faqItems = [
                { 
                    question: "Is HobbyHop a long-term commitment, or can I cancel anytime?",
                    answer: "HobbyHop is intentionally designed to be <strong>low-commitment</strong>. All memberships are month-to-month and can be canceled or paused at any time before your next billing cycle. There are no term-based contracts, mitigating your financial risk." 
                },
                { 
                    question: `What is the difference between Class Passes and Hop Points (HP)?`,
                    answer: `This is our dual-currency model: <ul><li><strong>Class Passes:</strong> The currency you <strong>buy</strong> with your monthly subscription. Used exclusively to book Hop-In Classes. All classes cost exactly ${PASSES_PER_CLASS} Pass.</li><li><strong>Hop Points (HP):</strong> The reward currency you <strong>earn</strong> (via milestones, referrals, and reviews). They cannot be purchased.</li></ul>You can redeem <strong>${HP_PER_FREE_PASS} HP</strong> for <strong>1 Free Class Pass</strong>.` 
                },
                { 
                    question: "Do my unused Class Passes or Hop Points expire?",
                    answer: `<strong>Class Passes:</strong> Yes, Passes purchased through your monthly plan <strong>expire</strong> at the end of the billing cycle. This policy ensures adequate slot availability across our partner network. We encourage you to check out our <strong>Adventure Bundles</strong> to maximize usage.<br><br><strong>Hop Points:</strong> No, HP <strong>do not expire</strong> as long as your account remains active (used once every six months).` 
                },
                { 
                    question: "Can I use one account/plan to book activities for multiple children?",
                    answer: "Yes! You can register multiple children under your main parent profile. We recommend the <strong>Family Tier</strong>, as it provides the largest pool of Passes to handle simultaneous bookings across different schedules and interests." 
                },
                { 
                    question: "Why is HobbyHop exclusively focused on Toronto?",
                    answer: "We are focused solely on key Toronto neighborhoods to build <strong>deep local network effects</strong> and guarantee a high density of quality, convenient Hop-In options. This ensures we truly solve the logistical problem for Toronto families before expanding." 
                },
                { 
                    question: "What types of activities and services are available?",
                    answer: "We offer a diverse range of <strong>Sport</strong> (Soccer, Martial Arts, Dance), <strong>Arts</strong>, <strong>STEM</strong> (Robotics, Science Labs), and <strong>Academic/Tutoring</strong> services, all vetted for quality and safety." 
                }
            ];

            return `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl card-shadow">
                    <h1 class="text-4xl font-extrabold text-hop-red mb-6 flex items-center space-x-3">
                        <i data-lucide="help-circle" class="w-8 h-8"></i>
                        <span>Frequently Asked Questions (FAQs)</span>
                    </h1>
                    <p class="text-lg text-gray-600 mb-8">
                        Find quick answers about our Class Passes, Hop Point system, commitment policies, and Toronto focus.
                    </p>

                    <div class="space-y-4">
                        ${faqItems.map((item, index) => `
                        <details id="faq-details-${index}" class="bg-gray-50 p-4 rounded-lg border border-gray-200" ontoggle="toggleIcon('faq-icon-${index}', this)">
                            <summary class="font-bold text-lg cursor-pointer flex justify-between items-center hover:text-hop-blue">
                                ${item.question}
                                <i data-lucide="chevron-down" id="faq-icon-${index}" class="w-5 h-5 flex-shrink-0 transition-transform"></i>
                            </summary>
                            <p class="mt-3 text-gray-700 ml-4 border-l-2 pl-4 border-hop-green">
                                ${item.answer}
                            </p>
                        </details>
                        `).join('')}
                    </div>

                    <div class="mt-8 pt-4 border-t text-center">
                        <button onclick="goToView('contact')" class="bg-hop-blue text-white py-3 px-6 rounded-full font-bold hover:bg-blue-600 transition">
                            Still Have Questions? Contact Our Support Team
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPlaceholderView(viewName) {
            return `
                <div class="bg-white p-8 rounded-xl card-shadow text-center">
                    <h1 class="text-4xl font-extrabold text-hop-blue mb-4">${viewName.charAt(0).toUpperCase() + viewName.slice(1)} Page</h1>
                    <i data-lucide="wrench" class="w-16 h-16 mx-auto text-yellow-500 mb-6"></i>
                    <p class="text-xl text-gray-600 mb-6">This feature is currently under construction, but rest assured, all links are active and working!</p>
                    <p class="text-gray-500">You successfully navigated to the <strong>${viewName}</strong> view.</p>
                    <button onclick="goToView('home')" class="mt-8 bg-hop-red text-white py-3 px-6 rounded-full font-bold hover:bg-red-600 transition">Return Home</button>
                </div>
            `;
        }
        
        function renderContactPage() {
            return `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl card-shadow">
                    <h1 class="text-4xl font-extrabold text-hop-red mb-4">Contact Our Support Team</h1>
                    <p class="text-xl text-gray-600 mb-10">We're here to help you navigate your child's adventure. Reach out with any questions about booking, partnerships, or Passes.</p>

                    <div class="grid md:grid-cols-2 gap-8 mb-10">
                        <!-- Contact Info -->
                        <div class="space-y-4">
                            <h2 class="text-2xl font-bold text-hop-blue mb-3">Get In Touch</h2>
                            <div class="flex items-center space-x-3">
                                <i data-lucide="mail" class="w-6 h-6 text-hop-green"></i>
                                <div>
                                    <p class="font-semibold text-gray-700">Email Support</p>
                                    <p class="text-lg">support@hobbyhop.ca</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <i data-lucide="phone" class="w-6 h-6 text-hop-green"></i>
                                <div>
                                    <p class="font-semibold text-gray-700">Phone</p>
                                    <p class="text-lg">1-800-HOP-KIDS</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3 pt-4">
                                <i data-lucide="map-pin" class="w-6 h-6 text-hop-green flex-shrink-0 mt-1"></i>
                                <div>
                                    <p class="font-semibold text-gray-700">Office (Toronto Focus)</p>
                                    <p class="text-lg">Serving Toronto families.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Form -->
                        <div class="bg-gray-50 p-6 rounded-xl border">
                            <h2 class="text-2xl font-bold text-hop-red mb-4">Send Us a Message</h2>
                            <form onsubmit="event.preventDefault(); alert('Thank you! Your general inquiry has been sent to our support team.'); this.reset();">
                                <input type="text" placeholder="Your Name" class="w-full p-3 mb-3 border rounded-lg" required>
                                <input type="email" placeholder="Your Email" class="w-full p-3 mb-3 border rounded-lg" required>
                                <textarea placeholder="Your Inquiry (e.g., billing question, technical issue)" class="w-full p-3 mb-4 border rounded-lg h-24" required></textarea>
                                <button type="submit" class="bg-hop-blue text-white py-3 px-6 rounded-full font-bold hover:bg-blue-600 transition card-shadow w-full">
                                    Submit Inquiry
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLoginPage() {
            return `
                <div class="max-w-xl mx-auto bg-white p-8 rounded-xl card-shadow mt-10">
                    <h1 class="text-3xl font-extrabold text-hop-blue mb-4">Welcome Back!</h1>
                    <p class="text-gray-600 mb-6">Log in to view your Adventure Board and Passes.</p>

                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Parent Email</label>
                            <input type="email" id="login-email" name="login-email" placeholder="you@family.com" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" name="login-password" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>

                        <button type="submit" class="w-full bg-hop-blue text-white py-3 text-lg font-bold rounded-full hover:bg-blue-600 transition card-shadow transform hover:scale-[1.01]">
                            Log In
                        </button>
                        <p class="text-center mt-4 text-sm text-gray-500">Don't have an account? <a href="#" onclick="goToView('register')" class="text-hop-red font-semibold hover:underline">Start Your Adventure</a></p>
                    </form>
                </div>
            `;
        }

        function renderAboutPage() {
            const team = window.state.teamMembers;
            return `
                <div class="bg-white p-8 rounded-xl card-shadow">
                    <h1 class="text-4xl font-extrabold text-hop-blue mb-4">Our Mission: Making Discovery Accessible</h1>
                    <p class="text-xl text-gray-600 mb-8">
                        At HobbyHop, we believe every child deserves the chance to discover what they love. We make it easy for parents to explore art, music, sports, all in one place, without the long-term commitment. Our mission is to spark curiosity, build confidence, and connect kids with experiences that help them grow, one hop at a time.
                    </p>

                    <h2 class="text-3xl font-extrabold text-hop-red mb-6 border-t pt-6">The Team Behind the Hop</h2>

                    <div class="bg-gray-100 p-4 rounded-lg mb-6 border-l-4 border-yellow-500">
                        <p class="font-bold text-lg text-gray-800">Venture Field Project (VFP) Team 3</p>
                        <p class="text-gray-600">This platform was developed as a venture project for the <strong>Ivey Business School Digital Management 2024-2025</strong> program, focusing on high-impact, digitally-enabled solutions.</p>
                    </div>

                    <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6">
                        ${team.map(member => `
                            <div class="bg-white p-4 rounded-xl card-shadow text-center border border-gray-200">
                                <img src="https://placehold.co/80x80/EA4335/ffffff?text=${member.name.charAt(0)}" alt="${member.name} photo" class="rounded-full mx-auto mb-3 border-4 border-hop-red/50">
                                <p class="font-bold text-lg">${member.name}</p>
                                <p class="text-sm text-hop-blue font-semibold">${member.role}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="text-center mt-12">
                        <button onclick="goToView('partners')" class="bg-hop-green text-white py-3 px-6 rounded-full font-bold hover:bg-green-600 transition">
                            See Partnership Opportunities
                        </button>
                    </div>
                </div>
            `;
        }
        
        // --- REFERRAL PAGE (HP Logic Applied) ---
        function renderReferralPage() {
            const code = window.state.user.referralCode;
            const isLoggedIn = window.state.user.isLoggedIn;
            const rewardHP = window.state.REFERRAL_HP_BONUS;
            const rewardPasses = rewardHP / window.state.HP_FOR_FREE_PASS; // 100 HP / 100 HP = 1 Pass
            const HP_PER_FREE_PASS = window.state.HP_FOR_FREE_PASS;
            
            // Simple function to handle copying the code to the clipboard
            const handleCopy = `
                function() {
                    const tempInput = document.createElement('input');
                    tempInput.value = document.getElementById('referral-code-input').value;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    alert('Referral Code Copied to clipboard! Go share the adventure!');
                }
            `;

            if (!isLoggedIn) {
                return `
                    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl card-shadow mt-10 text-center">
                        <h1 class="text-3xl font-extrabold text-hop-green mb-6">Unlock ${rewardPasses} FREE Pass Instantly!</h1>
                        <p class="text-xl text-gray-600 mb-8">
                            Join HobbyHop today to gain access to your unique referral code. When a friend signs up with your code, <strong>you both earn ${rewardHP} Hop Points!</strong> (That's 1 free class each)
                        </p>
                        
                        <h2 class="text-2xl font-bold text-hop-red mb-6">4 Simple Steps to Earn</h2>
                        
                        <!-- Visual Flowchart for How To Earn -->
                        <div class="grid md:grid-cols-4 gap-4 mb-8">
                            
                            <!-- Step 1: Register -->
                            <div class="p-4 rounded-lg text-center bg-hop-blue/10">
                                <div class="w-10 h-10 bg-hop-blue text-white rounded-full flex items-center justify-center mx-auto mb-2 text-xl font-bold">1</div>
                                <i data-lucide="user-plus" class="w-6 h-6 text-hop-blue mx-auto mb-1"></i>
                                <p class="text-sm font-bold text-gray-800">Register</p>
                                <p class="text-xs text-gray-500">Create your HobbyHop account.</p>
                            </div>

                            <!-- Step 2: Share -->
                            <div class="p-4 rounded-lg text-center bg-hop-red/10">
                                <div class="w-10 h-10 bg-hop-red text-white rounded-full flex items-center justify-center mx-auto mb-2 text-xl font-bold">2</div>
                                <i data-lucide="send" class="w-6 h-6 text-hop-red mx-auto mb-1"></i>
                                <p class="text-sm font-bold text-gray-800">Share Code</p>
                                <p class="text-xs text-gray-500">Send your unique code to a friend.</p>
                            </div>
                            
                            <!-- Step 3: Activate -->
                            <div class="p-4 rounded-lg text-center bg-hop-green/10">
                                <div class="w-10 h-10 bg-hop-green text-white rounded-full flex items-center justify-center mx-auto mb-2 text-xl font-bold">3</div>
                                <i data-lucide="check-circle" class="w-6 h-6 text-hop-green mx-auto mb-1"></i>
                                <p class="text-sm font-bold text-gray-800">Friend Activates</p>
                                <p class="text-xs text-gray-500">Friend completes their first paid month.</p>
                            </div>

                            <!-- Step 4: Earn -->
                            <div class="p-4 rounded-lg text-center bg-yellow-100">
                                <div class="w-10 h-10 bg-yellow-500 text-white rounded-full flex items-center justify-center mx-auto mb-2 text-xl font-bold">4</div>
                                <i data-lucide="star" class="w-6 h-6 text-yellow-700 fill-yellow-700 mx-auto mb-1"></i>
                                <p class="text-sm font-bold text-gray-800">You Both Earn</p>
                                <p class="text-xs text-gray-500">Instantly receive your ${rewardHP} HP!</p>
                            </div>

                        </div>

                        <p class="text-center mt-6 text-lg text-gray-700">Ready to earn your first free pass?</p>

                        <button onclick="goToView('register')" class="mt-4 bg-hop-red text-white py-3 px-8 text-lg font-bold rounded-full hover:bg-red-600 transition card-shadow w-full sm:w-auto transform hover:scale-105">
                            Start Your Child's Adventure 
                        </button>
                        <p class="text-center mt-4 text-sm text-gray-500">Already a member? <a href="#" onclick="goToView('login')" class="text-hop-blue font-semibold hover:underline">Log In Here</a></p>
                    </div>
                `;
            }

            return `
                <div class="bg-white p-8 rounded-xl card-shadow">
                    <h1 class="text-4xl font-extrabold text-hop-green mb-4 text-center">Refer & Unlock ${rewardPasses} FREE Pass!</h1>
                    <p class="text-xl text-gray-600 mb-10 text-center max-w-2xl mx-auto">
                        <strong>Word-of-mouth works best, so we digitize it!</strong> Refer a friend and you both get a huge bonus of <strong>${rewardHP} Hop Points</strong>, enough for <strong>${rewardPasses} FREE Class Pass</strong>!
                    </p>
                    
                    <!-- What are Hop Points? Dropdown (New Section) -->
                    <details class="bg-blue-50 p-4 rounded-xl border border-hop-blue/30 mb-8" ontoggle="toggleIcon('hp-info-icon', this)">
                        <summary class="font-bold text-lg cursor-pointer flex justify-between items-center text-hop-blue">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="star" class="w-5 h-5 text-yellow-600 fill-yellow-500"></i>
                                <span>What are Hop Points?</span>
                            </div>
                            <i data-lucide="chevron-down" id="hp-info-icon" class="w-5 h-5 flex-shrink-0 transition-transform"></i>
                        </summary>
                        <div class="mt-3 text-gray-700 ml-4 border-l-2 pl-4 border-hop-green">
                            <p class="mb-3">Hop Points (HP) are your <strong>reward currency</strong>. They are earned, not bought, and serve as free Passes for continuous exploration:</p>
                            
                            <h4 class="font-bold text-gray-800 flex items-center mb-1"><i data-lucide="rotate-cw" class="w-4 h-4 mr-2 text-hop-red"></i> Exchange Rate:</h4>
                            <p class="ml-6 mb-3">Redeem <strong>${HP_PER_FREE_PASS} HP</strong> to unlock <strong>1 Free Hop-In Pass</strong>.</p>
                            
                            <h4 class="font-bold text-gray-800 flex items-center mb-1"><i data-lucide="ticket" class="w-4 h-4 mr-2 text-hop-blue"></i> Redemption Usage:</h4>
                            <ul class="list-disc list-inside ml-6 text-gray-700">
                                <li><strong>Top-Up:</strong> Instantly buy additional Passes if you run out.</li>
                                <li><strong>Save Big:</strong> Combine HP for discounts on future Adventure Bundles.</li>
                            </ul>
                        </div>
                    </details>
                    
                    <!-- New Visual How-To Section -->
                    <h2 class="text-3xl font-extrabold text-hop-red mb-8 text-center">3 Steps to Your Free Pass</h2>
                    
                    <div class="grid md:grid-cols-3 gap-8 mb-10">
                        
                        <!-- Step 1: Share -->
                        <div class="p-6 rounded-xl bg-hop-blue/10 border-2 border-hop-blue/50 text-center">
                            <div class="w-16 h-16 bg-hop-blue text-white rounded-full flex items-center justify-center mx-auto mb-4 text-3xl font-extrabold card-shadow">1</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Share Your Code</h3>
                            <i data-lucide="share-2" class="w-8 h-8 text-hop-blue mx-auto my-2"></i>
                            <p class="text-sm text-gray-600">Copy your unique referral code and send it to any new parent in Toronto.</p>
                        </div>
                        
                        <!-- Step 2: Friend Activates -->
                        <div class="p-6 rounded-xl bg-hop-red/10 border-2 border-hop-red/50 text-center">
                            <div class="w-16 h-16 bg-hop-red text-white rounded-full flex items-center justify-center mx-auto mb-4 text-3xl font-extrabold card-shadow">2</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Friend Hops-In</h3>
                            <i data-lucide="user-plus" class="w-8 h-8 text-hop-red mx-auto my-2"></i>
                            <p class="text-sm text-gray-600">Your friend uses the code when they sign up and completes their first paid month.</p>
                        </div>

                        <!-- Step 3: Earn -->
                        <div class="p-6 rounded-xl bg-hop-green/10 border-2 border-hop-green/50 text-center">
                            <div class="w-16 h-16 bg-hop-green text-white rounded-full flex items-center justify-center mx-auto mb-4 text-3xl font-extrabold card-shadow">3</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">You Both Earn!</h3>
                            <i data-lucide="star" class="w-8 h-8 text-yellow-500 fill-yellow-500 mx-auto my-2"></i>
                            <p class="text-sm text-gray-600 font-bold">You both instantly receive ${rewardHP} HP, equaling 1 FREE Class Pass each!</p>
                        </div>
                    </div>
                    
                    <div class="max-w-xl mx-auto text-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Your Unique Referral Code</h2>
                        <div class="flex items-center justify-center bg-gray-100 p-4 rounded-xl border-2 border-dashed border-hop-green/50 card-shadow">
                            <input type="text" id="referral-code-input" value="${code}" readonly class="text-center p-0 border-none bg-transparent font-mono text-2xl sm:text-3xl font-extrabold text-gray-800 w-full select-all outline-none">
                            <button onclick="${handleCopy}" class="text-hop-blue ml-4 p-2 rounded-lg hover:bg-gray-200 transition flex-shrink-0">
                                <i data-lucide="copy" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Click the copy icon to share your code: <strong>${code}</strong></p>
                    </div>

                    <!-- Sharing Options -->
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Share With Your Community</h2>
                    <div class="flex justify-center space-x-6">
                        <button onclick="alert('Simulating Share via Email')" class="flex flex-col items-center p-3 hover:text-hop-red transition">
                            <i data-lucide="mail" class="w-8 h-8"></i>
                            <span class="text-sm mt-1">Email</span>
                        </button>
                        <button onclick="alert('Simulating Share via Facebook')" class="flex flex-col items-center p-3 hover:text-hop-blue transition">
                            <i data-lucide="facebook" class="w-8 h-8"></i>
                            <span class="text-sm mt-1">Facebook</span>
                        </button>
                        <button onclick="alert('Simulating Share via Text')" class="flex flex-col items-center p-3 hover:text-hop-green transition">
                            <i data-lucide="message-square" class="w-8 h-8"></i>
                            <span class="text-sm mt-1">Text/WhatsApp</span>
                        </button>
                    </div>
                    
                    <div class="mt-12 text-center border-t pt-6">
                        <p class="text-sm text-gray-500">Note: Points are awarded after your friend completes their first paid month.</p>
                        <button onclick="goToView('adventure')" class="mt-4 bg-hop-blue text-white py-3 px-6 rounded-full font-bold hover:bg-blue-600 transition">
                            Back to Adventure Board
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHomeView() {
            const bundles = window.state.mockBundles;
            return `
                <!-- Hero Section: Emphasis on Flexibility and CTA -->
                <div class="flex flex-col lg:flex-row items-center justify-between pt-10 pb-20 bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="lg:w-1/2 p-8 lg:p-12">
                        <!-- UPDATED HEADLINE -->
                        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold leading-tight mb-4">
                            <span class="text-hop-red">Hop.</span><br> 
                            <span class="text-hop-blue">Play.</span><br>
                            <span class="text-hop-green">Discover.</span>
                        </h1>
                        <p class="text-xl text-gray-600 mb-8">
                            HobbyHop removes the <strong>stress, cost, and rigid scheduling</strong> of extracurriculars, giving Toronto parents one simple way to say <strong>yes</strong> to their child's curiosity.
                        </p>
                        
                        <div class="space-y-4">
                            <button onclick="goToView('register')" class="bg-hop-red text-white py-4 px-10 text-xl font-bold rounded-full hover:bg-red-600 transition card-shadow w-full sm:w-auto transform hover:scale-105">
                                Start Your Child's Adventure 
                                <i data-lucide="arrow-right" class="inline-block w-5 h-5 ml-2"></i>
                            </button>
                            <p class="text-sm text-gray-500">No long-term contracts. Just monthly Hop-In access.</p>
                        </div>
                    </div>
                    <div class="lg:w-1/2 mt-8 lg:mt-0 p-8 flex justify-center items-center">
                        <img src="https://t3.ftcdn.net/jpg/05/13/53/72/360_F_513537271_EjWPNYgcovQI0dMr78ontkTAEt7TvQ4h.jpg" alt="Children happily engaging in diverse sports and arts activities" class="rounded-xl card-shadow max-w-full h-auto">
                    </div>
                </div>
                
                <!-- Themed Bundle Scroll Section -->
                <section class="py-16">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-800">Themed Adventure Bundles</h2>
                        <a href="#" onclick="goToView('bundles')" class="text-hop-blue font-semibold flex items-center hover:underline flex-shrink-0">
                            View All <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                        </a>
                    </div>
                    
                    <div class="scroll-container flex space-x-6">
                        ${bundles.map(bundle => `
                            <div onclick="goToView('bundles', { id: ${bundle.id} })" class="inline-block w-80 bg-white rounded-xl card-shadow overflow-hidden border border-gray-100 flex-shrink-0 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                                <img src="${bundle.image}" alt="${bundle.name} theme image" class="w-full h-32 object-cover" ${bundle.id !== 101 ? "onerror=\"this.onerror=null;this.src='https://placehold.co/400x200/555555/ffffff?text=" + bundle.theme.replace(/\s/g, '+') + "';\"" : ""}>
                                <div class="p-4">
                                    <span class="text-xs font-semibold text-hop-red uppercase">${bundle.theme}</span>
                                    <h3 class="text-xl font-bold mt-1 mb-2">${bundle.name}</h3>
                                    <p class="text-sm text-gray-600 mb-3">${bundle.description}</p>
                                    <div class="flex items-center justify-between">
                                        <span class="font-bold text-lg text-hop-blue">${bundle.passes} Passes</span>
                                        <button class="text-sm bg-hop-green text-white px-3 py-1 rounded-full">Explore</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>


                <!-- Core Value Proposition Section (The 3 Main Hurdles) -->
                <section class="py-16">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-center mb-10 text-gray-800">Solve the 3 Main Hurdles of Family Activities</h2>
                    
                    <div class="grid md:grid-cols-3 gap-8">
                        
                        <!-- Value 1: Fragmentation/Discovery - Centered -->
                        <div class="bg-white p-6 rounded-xl card-shadow hover:shadow-xl transition transform hover:-translate-y-1 centered-icon-card">
                            <div class="w-16 h-16 mb-4 p-3 bg-blue-100 rounded-full flex items-center justify-center">
                                <i data-lucide="map-pin" class="w-10 h-10 text-hop-blue"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3">One Hop-In, Endless Options</h3>
                            <p class="text-gray-600">No more fragmented searching across outdated websites. Find every verified sports, arts, and skill-building class in your neighborhood on one Adventure Board.</p>
                        </div>

                        <!-- Value 2: Scheduling Flexibility (The main VP) - Centered -->
                        <div class="bg-white p-6 rounded-xl card-shadow hover:shadow-xl transition transform hover:-translate-y-1 centered-icon-card">
                            <div class="w-16 h-16 mb-4 p-3 bg-red-100 rounded-full flex items-center justify-center">
                                <i data-lucide="clock" class="w-10 h-10 text-hop-red"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3">Adaptable Schedules & Hop-In Spots</h3>
                            <p class="text-gray-600 font-bold">The #1 focus.</p>
                            <p class="text-gray-600">Dual-income families rejoice! Book make-up sessions, trial classes, or drop-ins that fit around work, shifts, and multiple children. Flexibility guaranteed.</p>
                        </div>
                        
                        <!-- Value 3: High Sunk Costs/Risk - Centered -->
                        <div class="bg-white p-6 rounded-xl card-shadow hover:shadow-xl transition transform hover:-translate-y-1 centered-icon-card">
                            <div class="w-16 h-16 mb-4 p-3 bg-green-100 rounded-full flex items-center justify-center">
                                <i data-lucide="credit-card" class="w-10 h-10 text-hop-green"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3">Risk-Free Exploration with Passes</h3>
                            <p class="text-gray-600">Eliminate financial worry. Pay a low monthly fee for Pass Passes and use them on short-term classes. If they don't love it, you didn't waste a full term payment.</p>
                        </div>
                    </div>
                </section>
                
                <!-- Trust and Gamification Preview - UPDATED FOR HOP POINTS -->
                <section class="py-16 bg-white rounded-xl card-shadow my-8">
                    <h2 class="text-2xl sm:text-3xl font-extrabold text-center mb-4 text-hop-blue">Earn Rewards as You Go</h2>
                    <p class="text-center text-lg text-gray-600 mb-10">Welcome to the shared discovery journey. Earn <strong>Hop Points</strong> for more exploration!</p>
                    
                    <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto text-center">
                        <div class="p-4">
                            <i data-lucide="award" class="w-12 h-12 text-hop-red mx-auto mb-2"></i>
                            <h4 class="font-bold text-xl mb-1">Activity Completion</h4>
                            <p class="text-gray-500">Earn <strong>Hop Points</strong> for every class your child completes. (Redeemable for Passes)</p>
                        </div>
                        <div class="p-4">
                            <i data-lucide="message-square" class="w-12 h-12 text-hop-blue mx-auto mb-2"></i>
                            <h4 class="font-bold text-xl mb-1">Leave a Review</h4>
                            <p class="text-gray-500"><strong>Hop Points</strong> for providing quality feedback (builds community trust).</p>
                        </div>
                        <div class="p-4">
                            <i data-lucide="gift" class="w-12 h-12 text-hop-green mx-auto mb-2"></i>
                            <h4 class="font-bold text-xl mb-1">Refer & Get Free Passes</h4>
                            <p class="text-gray-500">Refer a friend, and you both get a huge HP bonus for <strong>free Hop-In Passes</strong>!</p>
                        </div>
                    </div>
                    
                    <div class="text-center mt-10">
                        <button onclick="goToView('pricing')" class="text-white py-3 px-8 text-lg font-bold rounded-full bg-hop-blue hover:bg-blue-600 transition transform hover:scale-105">
                            See Pricing & Start Earning
                        </button>
                    </div>
                </section>
            `;
        }

        function renderRegisterPage() {
            // Options for Toronto Neighborhoods
            const torontoNeighborhoods = [
                { value: 'Downtown Core', name: 'Downtown Core' },
                { value: 'Liberty Village', name: 'Liberty Village' },
                { value: 'The Annex', name: 'The Annex' },
                { value: 'North York', name: 'North York' },
                { value: 'Etobicoke', name: 'Etobicoke' },
                { value: 'Scarborough', name: 'Scarborough' },
            ];

            return `
                <div class="max-w-xl mx-auto bg-white p-8 rounded-xl card-shadow mt-10">
                    <h1 class="text-3xl font-extrabold text-hop-red mb-4">Start Your Adventure Profile</h1>
                    <p class="text-gray-600 mb-6">Tell us a little about your family to find activities in your neighborhood.</p>

                    <form onsubmit="handleSignUp(event)">
                        <h2 class="text-xl font-bold text-hop-blue mb-4 border-b pb-2">Your Account Info</h2>
                        <div class="mb-4">
                            <label for="email" class="block text-sm font-medium text-gray-700">Parent Email</label>
                            <input type="email" id="email" name="email" placeholder="you@family.com" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" name="password" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>

                        <h2 class="text-xl font-bold text-hop-red mb-4 border-b pb-2">Your Child's Interests (for data collection)</h2>
                        <div class="grid sm:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="location" class="block text-sm font-medium text-gray-700">Your Primary City/Neighborhood</label>
                                <select id="location" name="location" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                                    ${torontoNeighborhoods.map(n => `<option value="${n.value}, ON">${n.name}, ON</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="child-age" class="block text-sm font-medium text-gray-700">Age of Child (Target)</label>
                                <select id="child-age" name="child-age" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                                    <option value="3-5">3 - 5 (Early Explorers)</option>
                                    <option value="6-8">6 - 8 (Skill Builders)</option>
                                    <option value="9-12">9 - 12 (Focused Athletes)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-8">
                            <label for="child-interest" class="block text-sm font-medium text-gray-700">Child's Primary Interest</label>
                            <select id="child-interest" name="child-interest" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                                <option value="Sports">Sports (Soccer, Martial Arts, etc.)</option>
                                <option value="Arts">Arts & Creative</option>
                                <option value="STEM">STEM / Academic</option>
                                <option value="Music">Music</option>
                                <option value="Academic/Tutoring">Academic/Tutoring</option>
                            </select>
                        </div>

                        <button type="submit" class="w-full bg-hop-blue text-white py-3 text-lg font-bold rounded-full hover:bg-blue-600 transition card-shadow transform hover:scale-[1.01]">
                            Create Account & See Activities
                        </button>
                    </form>
                </div>
            `;
        }


        function renderAdventureBoard() {
            const activities = window.state.mockActivities;
            const milestones = window.state.mockMilestones;
            const message = window.state.data.message || ''; 
            
            // Options for Toronto Neighborhoods
            const torontoNeighborhoods = [
                { value: 'Downtown Core', name: 'Downtown Core' },
                { value: 'Liberty Village', name: 'Liberty Village' },
                { value: 'The Annex', name: 'The Annex' },
                { value: 'North York', name: 'North York' },
                { value: 'Etobicoke', name: 'Etobicoke' },
                { value: 'Scarborough', name: 'Scarborough' },
            ];

            return `
                <h1 class="text-4xl font-extrabold text-gray-800 mb-2">My Adventure Dashboard</h1>
                <!-- Conditional Message Display -->
                ${message ? `<p class="text-lg text-hop-green mb-8">${message}</p>` : `<div class="mb-8"></div>`}

                <!-- Duolingo-Inspired Adventure Board (Milestones) -->
                <section class="bg-white p-6 rounded-xl card-shadow mb-10">
                    <h2 class="text-3xl font-extrabold text-hop-red mb-6">Adventure Path Milestones</h2>
                    <p class="text-lg text-gray-600 mb-8">Complete activities and tasks to earn valuable <strong>Hop Points</strong> for discounts and rewards!</p>

                    <div class="milestone-path overflow-x-auto w-full pb-4 justify-start">
                        ${milestones.map((m, index) => `
                            <div class="milestone flex-shrink-0 mx-6 ${m.complete ? 'opacity-100' : 'opacity-60'}">
                                <div class="milestone-node ${m.complete ? 'bg-hop-green text-white' : 'bg-gray-200 text-gray-500'}">
                                    <i data-lucide="${m.icon}" class="w-6 h-6"></i>
                                </div>
                                <div class="mt-2 text-center w-24">
                                    <p class="text-sm font-bold text-gray-800">${m.name}</p>
                                    <span class="text-xs ${m.complete ? 'text-hop-green font-bold' : 'text-gray-500'}">
                                        ${m.complete ? 'Completed!' : `Reward: ${m.reward} HP`}
                                    </span>
                                </div>
                                ${!m.complete ? `
                                    <button class="text-xs bg-hop-blue text-white px-2 py-1 rounded-full mt-1 hover:bg-blue-600 transition" onclick="goToView('adventure', { message: 'Milestone tracking simulated: Go book a class!' })">
                                        Go
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </section>
                
                
                <!-- Hop-In Classes (Activity List) -->
                <h2 class="text-3xl font-extrabold text-gray-800 mb-2 border-t pt-8">Hop-In Classes</h2>
                <p class="text-xl text-hop-red mb-6">Spend Your Passes on Any Session - Flat Rate ${window.state.PASSES_PER_CLASS} Pass Per Class</p>

                <!-- Filter Panel: Now fully interactive and persistent -->
                <div class="bg-white p-6 rounded-xl card-shadow mb-8 sticky top-20 z-40">
                    <h3 class="font-bold text-xl mb-4 text-hop-blue">Find Your Next Hop-In</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <select id="filter-type" onchange="window.state.filters.type = this.value; applyFilters();" class="p-3 border rounded-lg focus:ring-hop-red focus:border-hop-red">
                            <option value="">Activity Type (All)</option>
                            <option value="Sport" ${window.state.filters.type === 'Sport' ? 'selected' : ''}>Sport (Soccer, Hockey, etc.)</option>
                            <option value="Art" ${window.state.filters.type === 'Art' ? 'selected' : ''}>Arts & Creative</option>
                            <option value="STEM" ${window.state.filters.type === 'STEM' ? 'selected' : ''}>STEM & Robotics</option>
                            <option value="Music" ${window.state.filters.type === 'Music' ? 'selected' : ''}>Music & Performance</option>
                            <option value="Academic/Tutoring" ${window.state.filters.type === 'Academic/Tutoring' ? 'selected' : ''}>Academic/Tutoring</option>
                        </select>
                        
                        <select id="filter-time" onchange="window.state.filters.time = this.value; applyFilters();" class="p-3 border rounded-lg focus:ring-hop-red focus:border-hop-red">
                            <option value="">Time of Day (Any)</option>
                            <option value="Afternoon" ${window.state.filters.time === 'Afternoon' ? 'selected' : ''}>After 4:00 PM</option>
                            <option value="Evening" ${window.state.filters.time === 'Evening' ? 'selected' : ''}>After 6:00 PM (Flex)</option>
                            <option value="Weekend" ${window.state.filters.time === 'Weekend' ? 'selected' : ''}>Weekend Mornings</option>
                        </select>
                        
                        <select id="filter-location" onchange="window.state.filters.location = this.value; applyFilters();" class="p-3 border rounded-lg focus:ring-hop-red focus:border-hop-red">
                            ${torontoNeighborhoods.map(n => `<option value="${n.value}" ${window.state.filters.location === n.value ? 'selected' : ''}>${n.name}</option>`).join('')}
                        </select>

                        <button onclick="applyFilters()" class="bg-hop-red text-white py-3 rounded-lg font-bold hover:bg-red-700 transition transform hover:scale-[1.02]">
                            Apply Filters
                        </button>
                    </div>
                </div>

                <!-- Adventure Board Grid -->
                <div class="adventure-grid">
                    ${activities.map(activity => `
                        <div onclick="goToView('activityDetail', { id: ${activity.id} })" 
                             class="bg-white p-5 rounded-xl border border-gray-100 card-shadow hover:shadow-2xl transition transform hover:-translate-y-1 cursor-pointer">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold bg-hop-green text-white px-3 py-1 rounded-full uppercase">Hop-In Spot</span>
                                <span class="text-xl font-bold text-hop-red">${activity.passes} Pass</span>
                            </div>
                            <h3 class="text-2xl font-bold mb-1 text-gray-800">${activity.name}</h3>
                            <p class="text-gray-500 mb-3">${activity.provider}</p>
                            
                            <div class="space-y-2 text-sm text-gray-700">
                                <div class="flex items-center"><i data-lucide="clock" class="w-4 h-4 mr-2 text-hop-blue"></i> ${activity.time}</div>
                                <div class="flex items-center"><i data-lucide="map-pin" class="w-4 h-4 mr-2 text-hop-red"></i> ${activity.location}</div>
                                <div class="flex items-center"><i data-lucide="star" class="w-4 h-4 mr-2 text-yellow-500 fill-yellow-500"></i> ${activity.rating}/5.0 Rating</div>
                            </div>
                            
                            <div class="mt-4 flex flex-wrap gap-2">
                                ${activity.tags.map(tag => `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">${tag}</span>`).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderBundlesPage() {
            const bundles = window.state.mockBundles;
            const message = window.state.data.message || 'Choose a themed pack to kickstart your child\'s exploration and maximize your Passes!';
            
            async function handleBundleMatch(event) {
                event.preventDefault();
                const form = event.target;
                const query = form.elements['child-personality'].value;
                const resultDiv = document.getElementById('match-result');
                const recommendButton = document.getElementById('recommend-button');

                resultDiv.innerHTML = '<div class="flex items-center justify-center space-x-2 text-hop-blue"><i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i><span>Analyzing personality and curriculum needs...</span></div>';
                recommendButton.disabled = true;

                try {
                    const bundleNames = bundles.map(b => b.name).join(", ");
                    const bundleDetails = bundles.map(b => `${b.name} (${b.focus}): ${b.description}`).join("; ");
                    
                    const systemPrompt = `You are a friendly, expert Child Development Matcher for HobbyHop. Your role is to analyze a child's personality and recommend the best-suited Themed Adventure Bundle. You MUST use the following bundle data to form your recommendation. Do not recommend anything not listed. Explain WHY the suggested bundle is a perfect fit for the child's needs in one paragraph.
Bundles Available: ${bundleDetails}
Available Bundle Names to Choose From: ${bundleNames}`;

                    const userQuery = `My child's personality and development needs are: "${query}". Based on the available bundles, which one is the absolute best match? Please output ONLY the recommended bundle name followed by a colon and your justification. Example: Creative Genius Journey: This bundle is a great match because...`;

                    const responseText = await callGeminiApi(userQuery, systemPrompt);
                    
                    // Simple parsing of the recommendation (assuming model follows the format)
                    const [name, justification] = responseText.includes(':') 
                        ? responseText.split(':', 2).map(s => s.trim()) 
                        : ['Recommendation', responseText];

                    const recommendedBundle = bundles.find(b => name.includes(b.name)) || null;

                    if (recommendedBundle) {
                        resultDiv.innerHTML = `
                            <div class="bg-hop-green/10 p-4 rounded-lg border-l-4 border-hop-green">
                                <p class="font-bold text-hop-green mb-2 flex items-center space-x-2"><i data-lucide="check-circle" class="w-5 h-5"></i><span>AI Match Found!</span></p>
                                <p class="text-lg text-gray-800">We recommend the <strong>${recommendedBundle.name}</strong>!</p>
                                <p class="text-sm text-gray-600 mt-2">${justification}</p>
                                <button onclick="goToView('pricing')" class="mt-4 bg-hop-red text-white py-2 px-4 rounded-full font-bold hover:bg-red-600 transition">
                                    Explore This Bundle
                                </button>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `<div class="p-4 bg-yellow-100 rounded-lg text-yellow-800">Recommendation: ${name}. ${justification}</div>`;
                    }

                } catch (error) {
                    resultDiv.innerHTML = `<div class="p-4 bg-red-100 rounded-lg text-red-800">Error: Could not retrieve match. Please try again.</div>`;
                    console.error('AI Match Error:', error);
                } finally {
                    lucide.createIcons();
                    recommendButton.disabled = false;
                }
            }

            // Temporarily define the function globally so it can be called from the form
            window.handleBundleMatch = handleBundleMatch;

            return `
                <h1 class="text-4xl font-extrabold text-hop-red mb-2">The Ultimate Adventure Bundles</h1>
                <p class="text-xl text-gray-600 mb-8">${message}</p>

                <!-- Gemini Feature: AI Adventure Matcher -->
                <section class="bg-blue-50 p-6 rounded-xl card-shadow mb-12 border-l-4 border-hop-blue">
                    <h2 class="text-2xl font-bold text-hop-blue mb-3 flex items-center space-x-2">
                        <i data-lucide="sparkles" class="w-6 h-6 fill-hop-blue"></i>
                        <span>AI Adventure Matcher</span>
                    </h2>
                    <p class="text-gray-700 mb-4">Unsure where to start? Describe your child's personality, interests, and development goals, and our AI will recommend the perfect bundle.</p>
                    <form onsubmit="window.handleBundleMatch(event)">
                        <textarea id="child-personality" name="child-personality" rows="3" placeholder="Example: My child is 7, high energy, loves team sports, but needs to work on focus and patience. We live in North York." 
                            class="w-full p-3 border border-gray-300 rounded-lg mb-4 resize-none" required></textarea>
                        <button id="recommend-button" type="submit" class="bg-hop-blue text-white py-3 px-6 rounded-full font-bold hover:bg-blue-600 transition card-shadow">
                            âœ¨ Find My Perfect Bundle
                        </button>
                    </form>
                    <div id="match-result" class="mt-6">
                        <!-- AI recommendation will appear here -->
                    </div>
                </section>
                <!-- End Gemini Feature -->

                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    ${bundles.map(bundle => `
                        <div class="bg-white p-6 rounded-xl card-shadow border-l-8 border-hop-blue/50 flex flex-col justify-between h-full">
                            <div>
                                <img src="${bundle.image}" alt="${bundle.name} theme image" class="w-full h-32 object-cover rounded-lg mb-4" ${bundle.id !== 101 ? "onerror=\"this.onerror=null;this.src='https://placehold.co/400x200/555555/ffffff?text=" + bundle.theme.replace(/\s/g, '+') + "';\"" : ""}>
                                <span class="text-xs font-semibold text-hop-green uppercase bg-green-100 px-3 py-1 rounded-full">${bundle.theme}</span>
                                <h3 class="text-2xl font-bold mt-2 mb-2 text-gray-800">${bundle.name}</h3>
                                <p class="text-gray-600 mb-4">${bundle.description}</p>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-100">
                                <p class="font-bold text-lg mb-2 flex items-center"><i data-lucide="ticket" class="w-5 h-5 mr-2 text-hop-red"></i> ${bundle.passes} Passes</p>
                                <p class="text-sm text-gray-500 mb-4">Includes access to ${bundle.activities} core activities.</p>
                                <button onclick="goToView('pricing')" class="w-full bg-hop-blue text-white py-3 rounded-full font-bold hover:bg-blue-600 transition">
                                    Choose This Pack
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="text-center mt-12">
                    <button onclick="goToView('pricing')" class="text-white py-3 px-8 text-lg font-bold rounded-full bg-hop-red hover:bg-red-600 transition transform hover:scale-105 card-shadow">
                        Skip Bundles & View Subscription Tiers
                    </button>
                </div>
            `;
        }


        function renderActivityDetail(id) {
            const activity = window.state.getActivityById(id);
            if (!activity) return `<h1 class="text-4xl text-hop-red">Activity Not Found</h1>`;

            const mockReviews = [
                { user: 'Marvin R.', date: 'Oct 2025', text: 'This class was perfect for my son. The skill-building was noticeable, and the instructor was fantastic. Highly recommend!', rating: 5, tags: ['Skill Building', 'Instructor Credibility'] },
                { user: 'Xiu Ping C.', date: 'Oct 2025', text: 'Great flexible timing for us shift workers! My daughter had so much fun and the location was super easy to get to.', rating: 4, tags: ['Location Convenience', 'Fun/Enjoyment'] },
                { user: 'Sam C.', date: 'Nov 2025', text: 'My child felt safe and truly enjoyed the activities. A great, risk-free way to try acrobatics without the full term cost.', rating: 5, tags: ['Safety', 'Fun/Enjoyment'] },
            ];
            
            async function handleInstructorQnA(event) {
                event.preventDefault();
                const form = event.target;
                const question = form.elements['parent-question'].value;
                const resultDiv = document.getElementById('qna-result');
                const askButton = document.getElementById('ask-button');

                resultDiv.innerHTML = '<div class="flex items-center space-x-2 text-hop-blue"><i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i><span>Generating expert response...</span></div>';
                askButton.disabled = true;

                try {
                    const instructorData = `Instructor Name: ${activity.instructor.name}. Certifications: ${activity.instructor.cert}. Experience: ${activity.instructor.testimonial}`;
                    
                    const systemPrompt = `You are the AI assistant for HobbyHop, specializing in providing grounded, reassuring answers to parents' questions about instructors. Your answer MUST be based ONLY on the following instructor profile data. If the data does not contain the information requested, state that politely. Answer in a confident, professional, and trustworthy tone.`;

                    const userQuery = `Instructor Profile: ${instructorData}. Parent's Question: "${question}"`;

                    const responseText = await callGeminiApi(userQuery, systemPrompt);
                    
                    resultDiv.innerHTML = `
                        <div class="bg-gray-100 p-3 rounded-lg border-l-4 border-hop-green">
                            <p class="font-bold text-gray-800 mb-1 flex items-center space-x-2"><i data-lucide="lightbulb" class="w-4 h-4 text-hop-green"></i><span>HobbyHop AI Response:</span></p>
                            <p class="text-sm text-gray-700">${responseText}</p>
                        </div>
                    `;

                } catch (error) {
                    resultDiv.innerHTML = `<div class="p-3 bg-red-100 rounded-lg text-red-800 text-sm">Error: Unable to connect to the AI service. Please check your network.</div>`;
                    console.error('AI Q&A Error:', error);
                } finally {
                    lucide.createIcons();
                    askButton.disabled = false;
                }
            }

            // Temporarily define the function globally so it can be called from the form
            window.handleInstructorQnA = handleInstructorQnA;


            return `
                <button onclick="goToView('adventure')" class="text-hop-blue font-semibold mb-6 flex items-center hover:underline">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Adventure Board
                </button>

                <div class="bg-white p-8 rounded-xl card-shadow">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 mb-6">
                        <h1 class="text-4xl font-extrabold text-gray-800">${activity.name}</h1>
                        <div class="text-right mt-3 md:mt-0">
                            <span class="text-3xl font-bold text-hop-red block">${activity.passes} Pass</span>
                            <span class="text-sm text-gray-500">Monthly Subscription Required</span>
                        </div>
                    </div>
                    
                    <!-- Activity Overview -->
                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <div>
                            <p class="font-bold text-gray-500">Provider</p>
                            <p class="text-lg">${activity.provider}</p>
                        </div>
                        <div>
                            <p class="font-bold text-gray-500">When</p>
                            <p class="text-lg">${activity.time}</p>
                        </div>
                        <div>
                            <p class="font-bold text-gray-500">Where</p>
                            <p class="text-lg">${activity.location}</p>
                        </div>
                    </div>
                    
                    <!-- Instructor Profile (Trust Signal) -->
                    <div class="bg-blue-50 p-6 rounded-xl mb-8 border border-hop-blue/30">
                        <h2 class="text-2xl font-bold text-hop-blue mb-3 flex items-center"><i data-lucide="user-check" class="w-6 h-6 mr-2"></i> Meet Your Instructor</h2>
                        <div class="flex items-center space-x-4">
                            <img src="https://placehold.co/60x60/4285F4/ffffff?text=H" alt="Instructor profile placeholder" class="rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/60x60/4285F4/ffffff?text=H';">
                            <div>
                                <p class="font-bold text-lg">${activity.instructor.name}</p>
                                <p class="text-sm text-gray-600"><strong>Certifications:</strong> ${activity.instructor.cert}</p>
                                <p class="text-sm text-gray-600"><strong>Testimonial:</strong> <em>"${activity.instructor.testimonial}"</em></p>
                            </div>
                        </div>
                    </div>

                    <!-- Gemini Feature: AI Instructor Q&A -->
                    <section class="bg-gray-100 p-6 rounded-xl mb-8 border-l-4 border-hop-red">
                        <h2 class="text-2xl font-bold text-hop-red mb-3 flex items-center space-x-2">
                            <i data-lucide="sparkles" class="w-6 h-6 fill-hop-red"></i>
                            <span>AI Instructor Q&A</span>
                        </h2>
                        <p class="text-gray-700 mb-4 text-sm">Get instant, credible answers about the instructor's background or class methods. (Powered by Gemini)</p>
                        <form onsubmit="window.handleInstructorQnA(event)">
                            <input type="text" id="parent-question" name="parent-question" placeholder="Example: How does Coach Mike handle safety for young children?" 
                                class="w-full p-2 border border-gray-300 rounded-lg mb-3" required>
                            <button id="ask-button" type="submit" class="bg-hop-blue text-white py-2 px-4 rounded-full text-sm font-bold hover:bg-blue-600 transition">
                                âœ¨ Ask Expert AI
                            </button>
                        </form>
                        <div id="qna-result" class="mt-4">
                            <!-- AI response appears here -->
                        </div>
                    </section>
                    <!-- End Gemini Feature -->


                    <!-- Call to Action -->
                    <button class="bg-hop-green text-white py-4 px-10 text-xl font-bold rounded-full hover:bg-green-600 transition card-shadow w-full transform hover:scale-[1.01] mb-8">
                        Book Hop-In Spot for ${activity.passes} Pass
                    </button>

                    <!-- Reviews Section -->
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Community Trust & Reviews</h2>
                    
                    <!-- Mock Gemini Summary -->
                    <div class="bg-yellow-50 p-4 rounded-lg mb-6 border-l-4 border-yellow-400 text-sm">
                        <p class="font-bold text-yellow-700">AI Review Insight (Gemini)</p>
                        <p class="text-yellow-800">${window.state.getGeminiSummary(mockReviews)}</p>
                    </div>

                    <!-- Review Score -->
                    <div class="flex items-center space-x-4 mb-6">
                        <p class="text-5xl font-extrabold text-hop-blue">${activity.rating}</p>
                        <div>
                            <div class="flex text-yellow-500">
                                <i data-lucide="star" class="w-6 h-6 fill-yellow-500"></i>
                                <i data-lucide="star" class="w-6 h-6 fill-yellow-500"></i>
                                <i data-lucide="star" class="w-6 h-6 fill-yellow-500"></i>
                                <i data-lucide="star" class="w-6 h-6 fill-yellow-500"></i>
                                <i data-lucide="star" class="w-6 h-6 ${activity.rating >= 5.0 ? 'fill-yellow-500' : 'text-gray-300'}"></i>
                            </div>
                            <p class="text-gray-600">Based on ${mockReviews.length + 12} verified bookings</p>
                        </div>
                        
                        <!-- AI Matching Button -->
                        <button class="bg-gray-100 text-gray-700 py-2 px-4 rounded-full text-sm font-semibold hover:bg-gray-200 transition">
                            <i data-lucide="user" class="w-4 h-4 inline-block mr-1"></i> Reviews from Similar Families (AI Match)
                        </button>
                    </div>
                    
                    <!-- Individual Reviews -->
                    <div class="space-y-4">
                        ${mockReviews.map(review => `
                            <div class="p-4 border rounded-lg bg-gray-50">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold">${review.user}</span>
                                    <span class="text-sm text-gray-500">${review.date}</span>
                                </div>
                                <p class="mb-3">${review.text}</p>
                                <div class="flex flex-wrap gap-2">
                                    ${review.tags.map(tag => `<span class="text-xs bg-hop-blue/10 text-hop-blue px-2 py-1 rounded-full border border-hop-blue/30">${tag}</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderPricingPage() {
            // TIER DATA: Passes are for buying classes.
            const tiers = [
                // Starter: $39 gets 2 Passes
                { name: 'Starter', price: 39, passes: 2, classesPerMonth: 2, color: 'bg-hop-green', value: 'Perfect for dipping a toe in.' },
                // Explorer: $79 gets 5 Passes
                { name: 'Explorer', price: 79, passes: 5, classesPerMonth: 5, color: 'bg-hop-blue', value: 'Best for sampling different sports.' },
                // Family: $109 gets 8 Passes
                { name: 'Family', price: 109, passes: 8, classesPerMonth: 8, color: 'bg-hop-red', value: 'Maximum flexibility for multiple children.' }
            ];

            return `
                <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-4">Choose Your Adventure Tier</h1>
                <p class="text-xl text-center text-gray-600 mb-12">Flexible, risk-free access for less than the cost of a full term. All classes cost <strong>1 Pass</strong>.</p>

                <div class="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                    ${tiers.map(tier => `
                        <div class="bg-white p-8 rounded-xl card-shadow border-t-8 ${tier.color} transition transform hover:scale-[1.02] relative overflow-hidden">
                            ${tier.name === 'Explorer' ? '<span class="absolute top-0 right-0 bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-bl-lg">Most Popular</span>' : ''}
                            <h2 class="text-3xl font-bold mb-2 ${tier.name === 'Explorer' ? 'text-hop-blue' : 'text-gray-800'}">${tier.name}</h2>
                            <p class="text-gray-500 mb-4">${tier.value}</p>
                            
                            <p class="text-5xl font-extrabold mb-1">$${tier.price}<span class="text-2xl font-normal text-gray-500">/month</span></p>
                            <p class="text-sm font-semibold text-gray-600 mb-6">~ $${(tier.price / tier.passes).toFixed(2)} per Pass</p>
                            
                            <div class="space-y-3 mb-8">
                                <div class="flex items-center text-gray-700">
                                    <i data-lucide="ticket" class="w-5 h-5 mr-3 text-hop-green"></i>
                                    <span><strong>${tier.passes} Class Passes</strong> per month</span>
                                </div>
                                <div class="flex items-center text-gray-700">
                                    <i data-lucide="calendar" class="w-5 h-5 mr-3 text-hop-red"></i>
                                    <span>Flexible Hop-In scheduling</span>
                                </div>
                                <div class="flex items-center text-gray-700">
                                    <i data-lucide="star" class="w-5 h-5 mr-3 text-yellow-500"></i>
                                    <span>Earn Hop Points with every booking</span>
                                </div>
                            </div>

                            <button onclick="goToView('register')" class="w-full ${tier.color} text-white py-3 rounded-full font-bold text-lg hover:opacity-90 transition">
                                Select ${tier.name}
                            </button>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Consolidated Referral/HP Information CTA -->
                <div class="bg-gray-100 p-8 rounded-xl card-shadow mt-8 text-center max-w-3xl mx-auto border-l-4 border-hop-green">
                    <h3 class="text-2xl font-bold mb-2 text-hop-green">Maximize Your Adventure with Hop Points</h3>
                    <p class="text-gray-700 mb-4">Learn how to earn <strong>FREE Passes</strong> through referrals and milestones.</p>
                    <button onclick="goToView('referral')" class="text-white py-3 px-6 rounded-full font-bold bg-hop-red hover:bg-red-600 transition card-shadow">
                        Learn More About Our Referral Program
                    </button>
                </div>
            `;
        }

        function renderPartnersPage() {
            const stats = window.state.mockPartnerStats;
            return `
                <div class="bg-white p-8 rounded-xl card-shadow">
                    <h1 class="text-4xl font-extrabold text-hop-red mb-4">Partner with HobbyHop: Grow Your Program, Not Your Admin</h1>
                    <p class="text-xl text-gray-600 mb-10">We help you fill underutilized slots, reduce admin burden, and acquire new, loyal families in Toronto. Focus on coaching, we handle the payments and registration.</p>

                    <!-- Success Metrics (B & C Priority) -->
                    <div class="grid md:grid-cols-3 gap-8 mb-12 text-center">
                        <div class="p-6 bg-hop-blue/10 rounded-xl border border-hop-blue/30">
                            <p class="text-5xl font-extrabold text-hop-blue">${stats.adminTimeSaved}%</p>
                            <p class="font-semibold mt-2">Reduction in Registration Admin Time</p>
                            <p class="text-sm text-gray-600">(Operational Efficiency)</p>
                        </div>
                        <div class="p-6 bg-hop-red/10 rounded-xl border border-hop-red/30">
                            <p class="text-5xl font-extrabold text-hop-red">${(stats.newFamilies / 100).toFixed(0)}K+</p>
                            <p class="font-semibold mt-2">New Families Introduced to Partners</p>
                            <p class="text-sm text-gray-600">(Reach/Exposure)</p>
                        </div>
                        <div class="p-6 bg-hop-green/10 rounded-xl border border-hop-green/30">
                            <p class="text-5xl font-extrabold text-hop-green">${(stats.totalBookings / 1000).toFixed(1)}K+</p>
                            <p class="font-semibold mt-2">Total Hop-In Bookings Fulfilled</p>
                            <p class="text-sm text-gray-600">(Volume & Reach)</p>
                        </div>
                    </div>

                    <!-- Value Proposition for Providers -->
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Our Value Proposition</h2>
                    <ul class="space-y-4 text-lg">
                        <li class="flex items-start">
                            <i data-lucide="zap" class="w-6 h-6 mr-3 mt-1 text-hop-blue flex-shrink-0"></i>
                            <span><strong>Guaranteed Payment & Zero Admin:</strong> We handle all monthly billing, payments, and pass calculations. You get paid per Hop-In class with simplified reconciliation.</span>
                        </li>
                        <li class="flex items-start">
                            <i data-lucide="trending-up" class="w-6 h-6 mr-3 mt-1 text-hop-red flex-shrink-0"></i>
                            <span><strong>Fill Empty Capacity:</strong> Convert unused spots into revenue. Our flexible scheduling model is designed to fill the class openings that traditional term registrations miss.</span>
                        </li>
                        <li class="flex items-start">
                            <i data-lucide="megaphone" class="w-6 h-6 mr-3 mt-1 text-hop-green flex-shrink-0"></i>
                            <span><strong>Targeted Exposure:</strong> Reach thousands of new, exploratory families in <strong>Toronto</strong> who are actively looking for risk-free trial options.</span>
                        </li>
                    </ul>

                    <!-- Partner CTA Form - NOW INCLUDES PARTNER TYPE DROPDOWN -->
                    <div class="mt-12 bg-gray-50 p-6 rounded-xl border">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">Ready to Partner?</h3>
                        <form onsubmit="event.preventDefault(); alert('Thank you for your interest! A HobbyHop Partner Specialist will contact you soon.');">
                            <input type="text" placeholder="Organization/Name" class="w-full p-3 mb-3 border rounded-lg" required>
                            
                            <!-- NEW PARTNER TYPE DROPDOWN -->
                            <div class="mb-3">
                                <label for="partner-type" class="block text-sm font-medium text-gray-700 mb-1">Your Partner Type</label>
                                <select id="partner-type" class="w-full p-3 border rounded-lg" required>
                                    <option value="">-- Select One --</option>
                                    <option value="Service Provider">Activity/Service Provider (Studio, Club)</option>
                                    <option value="Institution">Community Center / School / Institution</option>
                                    <option value="Influencer">Social Media / Community Influencer</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <!-- END NEW PARTNER TYPE DROPDOWN -->

                            <input type="email" placeholder="Contact Email" class="w-full p-3 mb-3 border rounded-lg" required>
                            <input type="tel" placeholder="Phone Number" class="w-full p-3 mb-4 border rounded-lg">
                            <textarea placeholder="Tell us about your organization or platform" class="w-full p-3 mb-6 border rounded-lg"></textarea>
                            <button type="submit" class="bg-hop-red text-white py-3 px-6 rounded-full font-bold hover:bg-red-600 transition card-shadow">
                                Submit Partnership Request
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }


        // --- Initialization ---

        // The initial render of the app when the page loads
        window.onload = function() {
            // Check if Firebase/Firestore globals are present (not used in this mockup but for compliance)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

            // Initial rendering of the home view
            renderApp();
            renderChatModal(); // Ensure modal structure is in DOM on load
        };
    </script>
</body>
</html>
